#!/bin/bash
# Clone a repository as bare and create 4 fixed workspaces with tmux sessions
# Usage: clone-workspace -p|-w|-t <repo-url>

set -e

# Parse arguments
CATEGORY=""
REPO_URL=""
IS_INIT_REPO=false

while getopts "pwti" opt; do
  case $opt in
    p) CATEGORY="personal" ;;
    w) CATEGORY="work" ;;
    t) CATEGORY="tools" ;;
    i) IS_INIT_REPO=true ;;
    \?) echo "Invalid option: -$OPTARG" >&2; exit 1 ;;
  esac
done

shift $((OPTIND-1))
REPO_URL="$1"

# Validate arguments
if [ -z "$CATEGORY" ] || [ -z "$REPO_URL" ]; then
  echo "Usage: clone-workspace -p|-w|-t [-i] <repo-url>"
  echo ""
  echo "Flags:"
  echo "  -p    Clone to ~/personal"
  echo "  -w    Clone to ~/work"
  echo "  -t    Clone to ~/tools"
  echo "  -i    Initialize new/empty repo (creates main and dev branches)"
  echo ""
  echo "Examples:"
  echo "  clone-workspace -p git@github.com:user/myapp.git"
  echo "  clone-workspace -w git@github.com:company/project.git"
  echo "  clone-workspace -p -i git@github.com:user/brand-new-repo.git"
  exit 1
fi

# Extract repo name from URL
REPO_NAME=$(basename "$REPO_URL" .git)

# Set target directory based on category
TARGET_DIR="$HOME/$CATEGORY"
BARE_REPO="$TARGET_DIR/${REPO_NAME}.git"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Workspace Setup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Repository: $REPO_URL"
echo "Category:   $CATEGORY"
echo "Target:     $BARE_REPO"
echo "Workspaces: 4"
echo ""

# Create target directory if it doesn't exist
mkdir -p "$TARGET_DIR"

# Clone as bare repository
echo "ğŸ“¦ Cloning as bare repository..."
git clone --bare "$REPO_URL" "$BARE_REPO"

# Create .bare marker file for fast detection
touch "$BARE_REPO/.bare"

# Get default branch name
cd "$BARE_REPO"

if [ "$IS_INIT_REPO" = true ]; then
  # New/empty repo - initialize with main and dev branches
  echo "ğŸ†• Initializing new repository with main and dev branches..."
  echo ""

  # Create initial commit in a temporary worktree using --orphan
  TEMP_INIT="$BARE_REPO/.temp-init"
  git worktree add --orphan -b main "$TEMP_INIT"
  cd "$TEMP_INIT"

  # Create initial commit
  echo "# $REPO_NAME" > README.md
  git add README.md
  git commit -m "Initial commit"

  # Push main branch
  echo "  ğŸ“¤ Pushing main branch to origin..."
  git push -u origin main

  # Create and push dev branch from main
  git checkout -b dev
  echo "  ğŸ“¤ Pushing dev branch to origin..."
  git push -u origin dev

  # Clean up temp worktree
  cd "$BARE_REPO"
  git worktree remove "$TEMP_INIT"

  DEFAULT_BRANCH="main"
  COMMIT_SHA=$(git rev-parse main)

  echo "âœ… Repository initialized with main and dev branches"
  echo ""
else
  # Existing repo flow
  # For bare repos, branches are in refs/heads/ not refs/remotes/
  if git show-ref --verify --quiet refs/heads/main; then
    DEFAULT_BRANCH="main"
  elif git show-ref --verify --quiet refs/heads/master; then
    DEFAULT_BRANCH="master"
  else
    # Get the first available branch
    DEFAULT_BRANCH=$(git branch | head -1 | sed 's/^[* ]*//' | xargs)
  fi

  if [ -z "$DEFAULT_BRANCH" ]; then
    echo "âŒ Error: No branches found in repository"
    echo "ğŸ’¡ Tip: Use the -i flag for new/empty repositories"
    exit 1
  fi

  echo "ğŸ“ Default branch: $DEFAULT_BRANCH"
  echo ""

  # Get commit SHA for the default branch
  COMMIT_SHA=$(git rev-parse "$DEFAULT_BRANCH")
fi

# Create shared Claude Code configuration directory in bare repo
echo "ğŸ¤– Setting up shared Claude Code configuration..."
mkdir -p "$BARE_REPO/.claude"
echo ""

# Create 4 workspaces as detached HEAD
# This allows each workspace to independently checkout any branch
echo "ğŸ“ Creating 4 workspaces..."
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"

  # For init repos with -i flag: workspaces 1-2 from main, 3-4 from dev
  if [ "$IS_INIT_REPO" = true ]; then
    if [ $i -le 2 ]; then
      BRANCH_SHA=$(git rev-parse main)
      BRANCH_NAME="main"
    else
      BRANCH_SHA=$(git rev-parse dev)
      BRANCH_NAME="dev"
    fi
    echo "  [$i/4] Creating workspace: $WORKSPACE_PATH (at $BRANCH_NAME)"
    git worktree add --detach "$WORKSPACE_PATH" "$BRANCH_SHA"
  else
    # Standard flow: all workspaces from default branch
    echo "  [$i/4] Creating workspace: $WORKSPACE_PATH (at $DEFAULT_BRANCH)"
    git worktree add --detach "$WORKSPACE_PATH" "$COMMIT_SHA"
  fi

  # Add .claude to gitignore in this worktree
  # In worktrees, .git is a file pointing to the actual git dir
  # We need to find the real git directory for this worktree
  WORKTREE_GIT_DIR=$(git -C "$WORKSPACE_PATH" rev-parse --git-dir)
  mkdir -p "$WORKTREE_GIT_DIR/info"
  echo ".claude" >> "$WORKTREE_GIT_DIR/info/exclude"
done

echo ""
echo "ğŸ”— Symlinking Claude Code configuration to all workspaces..."
# Create symlinks so all worktrees share the same .claude config
cd "$BARE_REPO"
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"
  ln -sf "$BARE_REPO/.claude" "$WORKSPACE_PATH/.claude"
  echo "  [$i/4] Linked .claude to workspace $i"
done

echo ""
echo "ğŸ–¥ï¸  Creating tmux sessions..."

# Create 4 tmux sessions with consistent layout
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"
  # Sanitize repo name for tmux (replace dots with underscores)
  SAFE_REPO_NAME=$(echo "$REPO_NAME" | tr . _)
  SESSION_NAME="${SAFE_REPO_NAME}_${i}"

  echo "  [$i/4] Creating session: $SESSION_NAME"

  # Create detached session with window 1
  tmux new-session -ds "$SESSION_NAME" -c "$WORKSPACE_PATH"

  # Window 1: Split terminal (70%) + Claude Code (30%)
  # Run claude from worktree directory (uses .claude symlink for shared config)
  tmux split-window -t "$SESSION_NAME:1" -h -p 30 -c "$WORKSPACE_PATH" "claude"

  # Window 2: Nvim
  tmux new-window -t "$SESSION_NAME:2" -c "$WORKSPACE_PATH"
  tmux send-keys -t "$SESSION_NAME:2" 'nvim .' C-m

  # Focus on window 1
  tmux select-window -t "$SESSION_NAME:1"
done

echo ""
echo "âœ… Setup complete!"
echo ""
# Sanitize repo name for display
SAFE_REPO_NAME=$(echo "$REPO_NAME" | tr . _)

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ Workspace Navigation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Ctrl+h â†’ Workspace 1 (${SAFE_REPO_NAME}_1)"
echo "  Ctrl+j â†’ Workspace 2 (${SAFE_REPO_NAME}_2)"
echo "  Ctrl+k â†’ Workspace 3 (${SAFE_REPO_NAME}_3)"
echo "  Ctrl+l â†’ Workspace 4 (${SAFE_REPO_NAME}_4)"
echo ""
echo "ğŸ“‚ Workspace Locations:"
if [ "$IS_INIT_REPO" = true ]; then
  echo "  Workspace 1: $BARE_REPO/1 (from main)"
  echo "  Workspace 2: $BARE_REPO/2 (from main)"
  echo "  Workspace 3: $BARE_REPO/3 (from dev)"
  echo "  Workspace 4: $BARE_REPO/4 (from dev)"
else
  for i in 1 2 3 4; do
    echo "  Workspace $i: $BARE_REPO/$i (from $DEFAULT_BRANCH)"
  done
fi
echo ""
echo "ğŸ’¡ Usage:"
echo "  Each workspace is in detached HEAD state"
echo "  Create feature branches from main/dev independently in each workspace:"
echo "    git checkout -b feature-x origin/main"
echo "    git checkout -b feature-y origin/dev"
echo ""
echo "ğŸ¤– Claude Code Configuration:"
echo "  All workspaces share the same Claude Code config via symlinks"
echo "  Config location: $BARE_REPO/.claude"
echo "  MCP servers, settings, and session history are unified across all workspaces"
echo "  Claude runs from bare repo root with --add-dir <workspace>"
echo ""
echo "ğŸ¯ Attaching to workspace 1..."
sleep 1

# Attach to first workspace
tmux attach-session -t "${SAFE_REPO_NAME}_1"
