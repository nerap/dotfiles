#!/bin/bash
# Clone a repository as bare and create 4 fixed workspaces with tmux sessions
# Usage: clone-workspace -p|-w|-t <repo-url>

set -e

# Parse arguments
CATEGORY=""
REPO_URL=""
IS_INIT_REPO=false

while getopts "pwti" opt; do
  case $opt in
    p) CATEGORY="personal" ;;
    w) CATEGORY="work" ;;
    t) CATEGORY="tools" ;;
    i) IS_INIT_REPO=true ;;
    \?) echo "Invalid option: -$OPTARG" >&2; exit 1 ;;
  esac
done

shift $((OPTIND-1))
REPO_URL="$1"

# Validate arguments
if [ -z "$CATEGORY" ] || [ -z "$REPO_URL" ]; then
  echo "Usage: clone-workspace -p|-w|-t [-i] <repo-url>"
  echo ""
  echo "Flags:"
  echo "  -p    Clone to ~/personal"
  echo "  -w    Clone to ~/work"
  echo "  -t    Clone to ~/tools"
  echo "  -i    Initialize new/empty repo (creates main and dev branches)"
  echo ""
  echo "Examples:"
  echo "  clone-workspace -p git@github.com:user/myapp.git"
  echo "  clone-workspace -w git@github.com:company/project.git"
  echo "  clone-workspace -p -i git@github.com:user/brand-new-repo.git"
  exit 1
fi

# Extract repo name from URL
REPO_NAME=$(basename "$REPO_URL" .git)

# Set target directory based on category
TARGET_DIR="$HOME/$CATEGORY"
BARE_REPO="$TARGET_DIR/${REPO_NAME}.git"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Workspace Setup"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Repository: $REPO_URL"
echo "Category:   $CATEGORY"
echo "Target:     $BARE_REPO"
echo "Workspaces: 4"
echo ""

# Create target directory if it doesn't exist
mkdir -p "$TARGET_DIR"

# Clone as bare repository
echo "ğŸ“¦ Cloning as bare repository..."
git clone --bare "$REPO_URL" "$BARE_REPO"

# Create .bare marker file for fast detection
touch "$BARE_REPO/.bare"

# Get default branch name
cd "$BARE_REPO"

if [ "$IS_INIT_REPO" = true ]; then
  # New/empty repo - initialize with main and dev branches
  echo "ğŸ†• Initializing new repository with main and dev branches..."
  echo ""

  # Create initial commit in a temporary worktree using --orphan
  TEMP_INIT="$BARE_REPO/.temp-init"
  git worktree add --orphan -b main "$TEMP_INIT"
  cd "$TEMP_INIT"

  # Create initial commit
  echo "# $REPO_NAME" > README.md
  git add README.md
  git commit -m "Initial commit"

  # Push main branch
  echo "  ğŸ“¤ Pushing main branch to origin..."
  git push -u origin main

  # Create and push release branches from main
  git checkout -b release/staging
  echo "  ğŸ“¤ Pushing release/staging branch to origin..."
  git push -u origin release/staging

  git checkout main
  git checkout -b release/production
  echo "  ğŸ“¤ Pushing release/production branch to origin..."
  git push -u origin release/production

  # Clean up temp worktree
  cd "$BARE_REPO"
  git worktree remove "$TEMP_INIT"

  DEFAULT_BRANCH="main"
  COMMIT_SHA=$(git rev-parse main)

  echo "âœ… Repository initialized with main and dev branches"
  echo ""
else
  # Existing repo flow
  # For bare repos, branches are in refs/heads/ not refs/remotes/
  if git show-ref --verify --quiet refs/heads/main; then
    DEFAULT_BRANCH="main"
  elif git show-ref --verify --quiet refs/heads/master; then
    DEFAULT_BRANCH="master"
  else
    # Get the first available branch
    DEFAULT_BRANCH=$(git branch | head -1 | sed 's/^[* ]*//' | xargs)
  fi

  if [ -z "$DEFAULT_BRANCH" ]; then
    echo "âŒ Error: No branches found in repository"
    echo "ğŸ’¡ Tip: Use the -i flag for new/empty repositories"
    exit 1
  fi

  echo "ğŸ“ Default branch: $DEFAULT_BRANCH"
  echo ""

  # Get commit SHA for the default branch
  COMMIT_SHA=$(git rev-parse "$DEFAULT_BRANCH")
fi

# Create shared Claude Code configuration directory in bare repo
echo "ğŸ¤– Setting up shared Claude Code configuration..."
mkdir -p "$BARE_REPO/.claude"
echo ""

# Create 4 workspaces as detached HEAD
# This allows each workspace to independently checkout any branch
echo "ğŸ“ Creating 4 workspaces..."
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"

  # For init repos with -i flag: all workspaces start from main (detached HEAD)
  # Workspace 1: stays on main (planning/exploration only)
  # Workspaces 2-4: checkout feature/* branches as needed
  if [ "$IS_INIT_REPO" = true ]; then
    BRANCH_SHA=$(git rev-parse main)
    echo "  [$i/4] Creating workspace: $WORKSPACE_PATH (at main, detached HEAD)"
    git worktree add --detach "$WORKSPACE_PATH" "$BRANCH_SHA"
  else
    # Standard flow: all workspaces from default branch (detached HEAD)
    echo "  [$i/4] Creating workspace: $WORKSPACE_PATH (at $DEFAULT_BRANCH, detached HEAD)"
    git worktree add --detach "$WORKSPACE_PATH" "$COMMIT_SHA"
  fi

  # Add .claude to gitignore in this worktree
  # In worktrees, .git is a file pointing to the actual git dir
  # We need to find the real git directory for this worktree
  WORKTREE_GIT_DIR=$(git -C "$WORKSPACE_PATH" rev-parse --git-dir)
  mkdir -p "$WORKTREE_GIT_DIR/info"
  echo ".claude" >> "$WORKTREE_GIT_DIR/info/exclude"
done

echo ""
echo "ğŸ”— Symlinking Claude Code configuration to all workspaces..."
# Create symlinks so all worktrees share the same .claude config
cd "$BARE_REPO"
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"
  ln -sf "$BARE_REPO/.claude" "$WORKSPACE_PATH/.claude"
  echo "  [$i/4] Linked .claude to workspace $i"
done

echo ""
echo "ğŸ›¡ï¸  Setting up workspace 1 protections..."
# Create pre-commit hook in workspace 1 to prevent commits to protected branches
WORKSPACE_1_GIT_DIR=$(git -C "$BARE_REPO/1" rev-parse --git-dir)
mkdir -p "$WORKSPACE_1_GIT_DIR/hooks"
cat > "$WORKSPACE_1_GIT_DIR/hooks/pre-commit" << 'HOOK_EOF'
#!/bin/bash
# Prevent commits to protected branches in workspace 1 (planning workspace)

BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

# Block commits to main and release/* branches
if [[ "$BRANCH" == "main" ]] || [[ "$BRANCH" == release/* ]]; then
  echo "âŒ ERROR: Cannot commit to '$BRANCH' in workspace 1"
  echo ""
  echo "ğŸ›¡ï¸  Workspace 1 is for planning/exploration only"
  echo "Protected branches: main, release/*"
  echo ""
  echo "ğŸ’¡ Use workspaces 2-4 for feature development:"
  echo "   cd ../2 && git checkout -b feature/your-feature main"
  exit 1
fi

# Allow commits on other branches (e.g., feature/*)
exit 0
HOOK_EOF
chmod +x "$WORKSPACE_1_GIT_DIR/hooks/pre-commit"
echo "  âœ“ Workspace 1 protected (cannot commit to main or release/*)"

# For init repos, create local worktree documentation
if [ "$IS_INIT_REPO" = true ]; then
  echo ""
  echo "ğŸ“ Creating worktree setup documentation..."
  mkdir -p "$BARE_REPO/.worktree"
  cat > "$BARE_REPO/.worktree/SETUP.md" << 'DOC_EOF'
# Worktree Development Setup

This repository uses **git worktrees** for parallel development across 4 workspaces.

## Directory Structure

```
project.git/
â”œâ”€â”€ .bare                   # Marker for bare repository
â”œâ”€â”€ .claude/                # Shared Claude Code configuration
â”œâ”€â”€ .worktree/              # This documentation (local-only)
â”œâ”€â”€ 1/                      # Workspace 1 - Planning/Exploration (main branch)
â”œâ”€â”€ 2/                      # Workspace 2 - Feature Development
â”œâ”€â”€ 3/                      # Workspace 3 - Feature Development
â””â”€â”€ 4/                      # Workspace 4 - Feature Development
```

## Workspace Assignments

### Workspace 1: Planning & Exploration (main)
- **Purpose**: Strategic planning, architecture, code exploration
- **Branch**: Stays on `main` (read-only, protected by git hook)
- **Activities**:
  - Use Claude for codebase exploration
  - Create implementation plans
  - Review code and PRs
  - Document architectural decisions
- **Protection**: Cannot commit to `main` or `release/*` branches
- **Rule**: Never create feature branches here

### Workspaces 2-4: Feature Development (feature/*)
- **Purpose**: Implement features independently in parallel
- **Workflow**:
  ```bash
  # Workspace 2: Feature A
  cd 2/
  git checkout -b feature/user-authentication main
  # Develop, commit, push

  # Workspace 3: Feature B (parallel)
  cd ../3/
  git checkout -b feature/payment-system main
  # Develop independently

  # Workspace 4: Feature C (parallel)
  cd ../4/
  git checkout -b feature/notifications main
  # Work on another feature
  ```

## Branching Strategy (Trunk-Based Development)

```
main (trunk - always deployable)
â”œâ”€â”€ feature/*              # Short-lived feature branches
â”œâ”€â”€ release/staging        # Pre-production testing
â””â”€â”€ release/production     # Production release branch
```

### Branch Usage:
- **`main`**: Trunk branch where all features merge (always deployable)
- **`feature/*`**: Short-lived feature branches (delete after merge to main)
- **`release/staging`**: Deploy to staging for QA testing
- **`release/production`**: Deploy to production (tag releases: v1.0.0)

### Workflow:
1. Create feature branch from `main` in workspace 2/3/4
2. Develop and commit changes
3. Push and create PR to `main`
4. After PR merge, cherry-pick/merge to `release/staging` for QA
5. After QA approval, merge to `release/production`
6. Tag production releases: `git tag v1.0.0 release/production`
7. Delete feature branch

## Tmux Navigation

Switch between workspaces using tmux keybindings:
- **Ctrl+h** â†’ Workspace 1 (planning)
- **Ctrl+j** â†’ Workspace 2 (feature dev)
- **Ctrl+k** â†’ Workspace 3 (feature dev)
- **Ctrl+l** â†’ Workspace 4 (feature dev)

Or use the command:
```bash
switch-workspace 2  # Switch to workspace 2
```

## Claude Code Integration

All workspaces share the same Claude Code configuration via symlinks:
- **Config location**: `<repo>/.claude/`
- **Shared**: Settings, MCP servers, conversation history
- **Usage**: Start Claude manually in the right pane (50/50 split)

## Common Operations

### Create New Feature
```bash
cd 2/  # Or 3/ or 4/
git checkout -b feature/my-feature main
# Work on feature
git add .
git commit -m "Implement feature"
git push -u origin feature/my-feature
```

### Sync with Latest Main
```bash
cd 1/
git pull origin main  # Update workspace 1

cd 2/
git fetch origin
git rebase origin/main  # Rebase your feature branch
```

### Switch Feature in Workspace
```bash
cd 3/
git checkout main
git pull
git checkout -b feature/another-feature main
```

### Clean Up Merged Feature
```bash
# After feature merged to main
cd 2/
git checkout main
git pull
git branch -d feature/my-feature  # Delete local branch
git push origin --delete feature/my-feature  # Delete remote
```

## Troubleshooting

### "I accidentally committed in workspace 1"
The pre-commit hook should prevent this, but if you bypassed it:
```bash
cd 1/
git reset --soft HEAD~1  # Undo commit, keep changes
```

### "I want to add a 5th workspace"
```bash
cd <repo>.git/
git worktree add 5 main
ln -sf .claude 5/.claude
# Create tmux session manually or use switch-workspace 5
```

### "How do I remove a worktree?"
```bash
cd <repo>.git/
git worktree remove 3
git worktree prune
```

## Learn More

- [Git Worktree Docs](https://git-scm.com/docs/git-worktree)
- [Trunk-Based Development](https://trunkbaseddevelopment.com/)
DOC_EOF
  echo "  âœ“ Documentation created at: $BARE_REPO/.worktree/SETUP.md"
fi

echo ""
echo "ğŸ–¥ï¸  Creating tmux sessions..."

# Create 4 tmux sessions with consistent layout
for i in 1 2 3 4; do
  WORKSPACE_PATH="$BARE_REPO/$i"
  # Sanitize repo name for tmux (replace dots with underscores)
  SAFE_REPO_NAME=$(echo "$REPO_NAME" | tr . _)
  SESSION_NAME="${SAFE_REPO_NAME}_${i}"

  echo "  [$i/4] Creating session: $SESSION_NAME"

  # Create detached session with window 1
  tmux new-session -ds "$SESSION_NAME" -c "$WORKSPACE_PATH"

  # Window 1: Split terminal (50%) + Claude pane (50%)
  # Right pane is a terminal (not running claude directly)
  # This prevents Ctrl+C from closing the pane
  tmux split-window -t "$SESSION_NAME:1" -h -p 50 -c "$WORKSPACE_PATH"

  # Window 2: Nvim
  tmux new-window -t "$SESSION_NAME:2" -c "$WORKSPACE_PATH"
  tmux send-keys -t "$SESSION_NAME:2" 'nvim .' C-m

  # Focus on window 1
  tmux select-window -t "$SESSION_NAME:1"
done

echo ""
echo "âœ… Setup complete!"
echo ""
# Sanitize repo name for display
SAFE_REPO_NAME=$(echo "$REPO_NAME" | tr . _)

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ Workspace Navigation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  Ctrl+h â†’ Workspace 1 (${SAFE_REPO_NAME}_1)"
echo "  Ctrl+j â†’ Workspace 2 (${SAFE_REPO_NAME}_2)"
echo "  Ctrl+k â†’ Workspace 3 (${SAFE_REPO_NAME}_3)"
echo "  Ctrl+l â†’ Workspace 4 (${SAFE_REPO_NAME}_4)"
echo ""
echo "ğŸ“‚ Workspace Locations:"
if [ "$IS_INIT_REPO" = true ]; then
  echo "  Workspace 1: $BARE_REPO/1 (planning - protected main branch)"
  echo "  Workspace 2: $BARE_REPO/2 (feature dev - from main)"
  echo "  Workspace 3: $BARE_REPO/3 (feature dev - from main)"
  echo "  Workspace 4: $BARE_REPO/4 (feature dev - from main)"
  echo ""
  echo "ğŸ“‹ Branching Strategy:"
  echo "  main              â†’ Trunk (always deployable)"
  echo "  feature/*         â†’ Short-lived feature branches"
  echo "  release/staging   â†’ Pre-production testing"
  echo "  release/production â†’ Production releases"
  echo ""
  echo "ğŸ“ Documentation: $BARE_REPO/.worktree/SETUP.md"
else
  for i in 1 2 3 4; do
    echo "  Workspace $i: $BARE_REPO/$i (from $DEFAULT_BRANCH, detached HEAD)"
  done
fi
echo ""
echo "ğŸ’¡ Recommended Workflow:"
if [ "$IS_INIT_REPO" = true ]; then
  echo "  Workspace 1: Planning only (protected, cannot commit to main)"
  echo "  Workspaces 2-4: Feature development"
  echo ""
  echo "  Create features in workspaces 2-4:"
  echo "    cd 2/ && git checkout -b feature/my-feature main"
  echo "    cd 3/ && git checkout -b feature/another main"
else
  echo "  Each workspace is in detached HEAD state"
  echo "  Create feature branches as needed:"
  echo "    cd 2/ && git checkout -b feature/my-feature"
fi
echo ""
echo "ğŸ¤– Claude Code Configuration:"
echo "  All workspaces share the same Claude Code config via symlinks"
echo "  Config location: $BARE_REPO/.claude"
echo "  MCP servers, settings, and session history are unified across all workspaces"
echo "  Start Claude manually in the right pane (50/50 split)"
echo ""
echo "ğŸ¯ Attaching to workspace 1..."
sleep 1

# Attach to first workspace
tmux attach-session -t "${SAFE_REPO_NAME}_1"
