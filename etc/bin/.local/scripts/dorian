#!/usr/bin/env bash
# dorian - Claude Code CLI wrapper for plan-driven development
# Version: 1.0

set -eo pipefail

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m' # No Color

# Helpers
info() {
    echo -e "${BLUE}ℹ${NC}  $1"
}

success() {
    echo -e "${GREEN}✓${NC}  $1"
}

warning() {
    echo -e "${YELLOW}⚠${NC}   $1"
}

error() {
    echo -e "${RED}✗${NC}  $1"
}

title() {
    echo -e "${PURPLE}$1${NC}"
}

# Check if in a project with .dorian.json
has_dorian_config() {
    [[ -f ".dorian.json" ]]
}

# Show usage
usage() {
    cat <<EOF
$(title "dorian - Claude Code Plan-Driven Development CLI")

Usage:
  dorian init                     Initialize project with plan-driven workflow
  dorian plan "<description>"     Enter planning mode to create execution plan
  dorian exec <plan-file>         Execute a plan file
  dorian archive <plan-name>      Archive a completed plan
  dorian status                   Show current project status
  dorian list                     List all plans
  dorian config                   Show current configuration
  dorian [claude-args...]         Pass through to claude command

Options:
  -h, --help                      Show this help
  -v, --version                   Show version

Examples:
  dorian init                          # Setup new project
  dorian plan "Add dark mode"          # Create plan
  dorian exec PLAN-001-dark-mode.md    # Execute plan
  dorian archive PLAN-001-dark-mode    # Archive completed plan
  dorian                               # Regular claude session

Environment:
  DORIAN_TEMPLATE_DIR              Custom template directory
  DORIAN_AUTO_EXEC                 Auto-execute plans after creation (0/1)

EOF
}

# Show version
show_version() {
    echo "dorian version $VERSION"
}

# Show status
show_status() {
    if ! has_dorian_config; then
        error "Not a dorian project. Run: dorian init"
        exit 1
    fi

    title "=== Dorian Project Status ==="
    echo ""

    # Project info
    local project_name=$(jq -r '.project.name // "unknown"' .dorian.json)
    local project_type=$(jq -r '.project.type // "unknown"' .dorian.json)
    local current_mode=$(jq -r '.execution.mode // "classic"' .dorian.json)

    info "Project: $project_name"
    info "Type: $project_type"
    info "Mode: $current_mode"
    echo ""

    # Quality gates
    title "Quality Gates:"
    local test_enabled=$(jq -r '.quality_gates.test.enabled // false' .dorian.json)
    local test_cmd=$(jq -r '.quality_gates.test.command // "N/A"' .dorian.json)
    echo "  Tests:     $(if [[ "$test_enabled" == "true" ]]; then echo "✓"; else echo "✗"; fi) $test_cmd"

    local lint_enabled=$(jq -r '.quality_gates.lint.enabled // false' .dorian.json)
    local lint_cmd=$(jq -r '.quality_gates.lint.command // "N/A"' .dorian.json)
    echo "  Lint:      $(if [[ "$lint_enabled" == "true" ]]; then echo "✓"; else echo "✗"; fi) $lint_cmd"

    local build_enabled=$(jq -r '.quality_gates.build.enabled // false' .dorian.json)
    local build_cmd=$(jq -r '.quality_gates.build.command // "N/A"' .dorian.json)
    echo "  Build:     $(if [[ "$build_enabled" == "true" ]]; then echo "✓"; else echo "✗"; fi) $build_cmd"
    echo ""

    # Plans
    if [[ -d ".claude/plans" ]]; then
        local plan_count=$(find .claude/plans -name "PLAN-*.md" 2>/dev/null | wc -l | tr -d ' ')
        title "Plans: $plan_count total"
        if [[ $plan_count -gt 0 ]]; then
            find .claude/plans -name "PLAN-*.md" -exec basename {} \; | sort | tail -5 | while read plan; do
                echo "  - $plan"
            done
        fi
    fi
}

# List plans
list_plans() {
    if ! has_dorian_config; then
        error "Not a dorian project. Run: dorian init"
        exit 1
    fi

    title "=== Available Plans ==="
    echo ""

    if [[ ! -d ".claude/plans" ]]; then
        warning "No plans directory found"
        exit 0
    fi

    find .claude/plans -name "PLAN-*.md" | sort | while read plan; do
        local basename=$(basename "$plan")
        local status=$(grep "^**Status**:" "$plan" 2>/dev/null | sed 's/**Status**: //' || echo "unknown")
        echo "  $basename - Status: $status"
    done
}

# Show config
show_config() {
    if ! has_dorian_config; then
        error "Not a dorian project. Run: dorian init"
        exit 1
    fi

    title "=== Dorian Configuration ==="
    echo ""
    cat .dorian.json | jq .
}

# Main command dispatcher
main() {
    case "${1:-}" in
        init)
            "$SCRIPT_DIR/dorian-init" "${@:2}"
            ;;
        plan)
            if ! has_dorian_config; then
                error "Not a dorian project. Run: dorian init first"
                exit 1
            fi
            shift
            "$SCRIPT_DIR/dorian-set-mode" planning "$*"
            info "Launching Claude in planning mode..."
            claude
            ;;
        exec)
            if ! has_dorian_config; then
                error "Not a dorian project. Run: dorian init first"
                exit 1
            fi
            shift
            "$SCRIPT_DIR/dorian-set-mode" execution "$*"
            info "Launching Claude in execution mode..."
            claude --dangerously-skip-permissions
            ;;
        archive)
            if ! has_dorian_config; then
                error "Not a dorian project. Run: dorian init first"
                exit 1
            fi
            shift
            "$SCRIPT_DIR/dorian-archive" "$@"
            ;;
        status)
            show_status
            ;;
        list)
            list_plans
            ;;
        config)
            show_config
            ;;
        -h|--help|help)
            usage
            ;;
        -v|--version|version)
            show_version
            ;;
        *)
            # Pass through to claude
            claude "$@"
            ;;
    esac
}

main "$@"
