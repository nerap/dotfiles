#!/bin/bash
# dorian-archive - Archive a completed plan
#
# Usage:
#   dorian archive PLAN-20260114-dark-mode
#   dorian archive PLAN-20260114-dark-mode.md
#
# This command moves a plan from active/ to archive/{YYYY-MM}/ after PR is merged.
# Plans are local files (not committed to git), so this just moves files on the filesystem.

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0;no Color'

error() { echo -e "${RED}✗${NC} $1" >&2; exit 1; }
success() { echo -e "${GREEN}✓${NC} $1"; }
info() { echo -e "${BLUE}ℹ${NC} $1"; }
warning() { echo -e "${YELLOW}⚠${NC} $1"; }

# Check argument
if [ $# -eq 0 ]; then
  error "Usage: dorian archive PLAN-NAME"
fi

PLAN_ARG="$1"

# Strip .md extension if provided
PLAN_NAME="${PLAN_ARG%.md}"

# Find the .claude directory (works from any worktree or bare repo)
CLAUDE_DIR=""

# Check if we're in a worktree with .claude symlink
if [ -L .claude ]; then
  CLAUDE_DIR="$(readlink -f .claude 2>/dev/null || readlink .claude)"
elif [ -d .claude ]; then
  # Direct .claude directory
  CLAUDE_DIR="$(pwd)/.claude"
elif [ -d ../.claude ]; then
  # Bare repo root
  CLAUDE_DIR="$(cd ../.claude && pwd)"
else
  error "Cannot find .claude directory. Run this from a worktree or repo root."
fi

info "Using .claude directory: $CLAUDE_DIR"

# Check if plan exists in active/
PLAN_MD="$CLAUDE_DIR/plans/active/$PLAN_NAME.md"
PLAN_SH="$CLAUDE_DIR/plans/active/$PLAN_NAME.sh"

if [ ! -f "$PLAN_MD" ]; then
  error "Plan not found: $PLAN_MD"
fi

# Extract date from plan name (PLAN-YYYYMMDD-slug)
if [[ "$PLAN_NAME" =~ PLAN-([0-9]{4})([0-9]{2})[0-9]{2}- ]]; then
  YEAR="${BASH_REMATCH[1]}"
  MONTH="${BASH_REMATCH[2]}"
  ARCHIVE_DIR="$CLAUDE_DIR/plans/archive/$YEAR-$MONTH"
else
  # Fallback to current date if plan name doesn't match pattern
  ARCHIVE_DIR="$CLAUDE_DIR/plans/archive/$(date +%Y-%m)"
fi

# Create archive directory if it doesn't exist
mkdir -p "$ARCHIVE_DIR"

# Check if plan status is "completed"
if ! grep -q "^\*\*Status\*\*:.*completed" "$PLAN_MD"; then
  warning "Plan status is not 'completed'. Archive anyway? (y/N)"
  read -r response
  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    error "Archival cancelled."
  fi
fi

# Move files
info "Moving plan to archive: $ARCHIVE_DIR/"

mv "$PLAN_MD" "$ARCHIVE_DIR/"
success "Moved: $PLAN_NAME.md"

if [ -f "$PLAN_SH" ]; then
  mv "$PLAN_SH" "$ARCHIVE_DIR/"
  success "Moved: $PLAN_NAME.sh"
fi

echo ""
success "✅ Plan archived successfully!"
echo ""
info "Archived to: $ARCHIVE_DIR/$PLAN_NAME.md"
info "Plans are local files (not committed to git)"
echo ""
