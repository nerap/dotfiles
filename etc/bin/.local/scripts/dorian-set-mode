#!/usr/bin/env bash
# dorian-set-mode - Set the execution mode and prepare environment
# Usage: dorian-set-mode <mode> [args...]
# Modes: planning, execution, classic

set -eo pipefail

MODE="${1:-classic}"
ARGS="${2:-}"

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

info() {
    echo -e "${BLUE}ℹ${NC}  $1"
}

success() {
    echo -e "${GREEN}✓${NC}  $1"
}

# Update .dorian.json with current mode
update_mode() {
    local mode=$1
    local args=$2

    if [[ ! -f ".dorian.json" ]]; then
        echo "Error: .dorian.json not found"
        exit 1
    fi

    # Use jq to update the mode
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    if command -v jq >/dev/null 2>&1; then
        # Update mode and execution info
        cat .dorian.json | jq \
            --arg mode "$mode" \
            --arg ts "$timestamp" \
            --arg args "$args" \
            '.execution.mode = $mode | .execution.last_execution_time = $ts | .execution.current_plan = $args' \
            > .dorian.json.tmp
        mv .dorian.json.tmp .dorian.json
    else
        # Fallback without jq (basic sed)
        sed -i.bak "s/\"mode\": \"[^\"]*\"/\"mode\": \"$mode\"/" .dorian.json
        rm -f .dorian.json.bak
    fi
}

# Prepare environment for planning mode
setup_planning_mode() {
    info "Setting up planning mode..."

    # Ensure .claude directory exists
    if [[ ! -d ".claude" ]]; then
        # Check if we're in a worktree with bare repo parent
        parent_dir=$(dirname "$(pwd)")
        if [[ -f "$parent_dir/.bare" ]] || [[ -d "$parent_dir/.git" ]]; then
            # Symlink to parent's .claude
            if [[ -d "$parent_dir/.claude" ]]; then
                ln -s "$parent_dir/.claude" .claude
                info "Symlinked .claude from bare repo"
            fi
        else
            mkdir -p .claude/plans
            info "Created .claude/plans directory"
        fi
    fi

    # Ensure plans directory exists
    if [[ -d ".claude" ]] && [[ ! -d ".claude/plans" ]]; then
        mkdir -p .claude/plans
    fi

    update_mode "planning" "$ARGS"
    success "Planning mode activated"
    info "Feature request: $ARGS"
}

# Prepare environment for execution mode
setup_execution_mode() {
    local plan_file="$ARGS"

    info "Setting up execution mode..."

    if [[ -z "$plan_file" ]]; then
        echo "Error: Plan file required for execution mode"
        echo "Usage: dorian exec PLAN-001-feature.md"
        exit 1
    fi

    # Find the plan file
    if [[ -f ".claude/plans/$plan_file" ]]; then
        plan_file=".claude/plans/$plan_file"
    elif [[ -f "$plan_file" ]]; then
        # Full path provided
        :
    else
        echo "Error: Plan file not found: $plan_file"
        exit 1
    fi

    update_mode "execution" "$(basename $plan_file)"
    success "Execution mode activated"
    info "Plan: $(basename $plan_file)"

    # Show plan summary
    if [[ -f "$plan_file" ]]; then
        echo ""
        echo "Plan Summary:"
        grep "^**Status**:" "$plan_file" 2>/dev/null || true
        grep "^**Estimated Time**:" "$plan_file" 2>/dev/null || true
        grep "^**Branch**:" "$plan_file" 2>/dev/null || true
    fi
}

# Main
case "$MODE" in
    planning)
        setup_planning_mode
        ;;
    execution)
        setup_execution_mode
        ;;
    classic)
        update_mode "classic" ""
        success "Classic mode activated"
        ;;
    *)
        echo "Error: Unknown mode: $MODE"
        echo "Valid modes: planning, execution, classic"
        exit 1
        ;;
esac
