#!/usr/bin/env bash
# migrate-landing-to-dorian - Migrate landing project to dorian system
# Usage: migrate-landing-to-dorian [landing-bare-repo-path]

set -eo pipefail

LANDING_PATH="${1:-/Users/nerap/work/landing.git}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# Use realpath to resolve the path properly
DORIAN_TEMPLATES="$(cd "$SCRIPT_DIR" && cd ../../../.. && pwd)/.claude/templates"

# Verify templates exist
if [[ ! -d "$DORIAN_TEMPLATES" ]]; then
    # Fallback: use hardcoded path if relative fails
    DORIAN_TEMPLATES="/Users/nerap/personal/dotfiles/.claude/templates"
fi

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
NC='\033[0m'

info() { echo -e "${BLUE}ℹ${NC}  $1"; }
success() { echo -e "${GREEN}✓${NC}  $1"; }
warning() { echo -e "${YELLOW}⚠${NC}   $1"; }
error() { echo -e "${RED}✗${NC}  $1"; }
title() { echo -e "\n${PURPLE}━━━ $1 ━━━${NC}\n"; }

# Banner
show_banner() {
    echo ""
    echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║                                        ║${NC}"
    echo -e "${PURPLE}║  ${BLUE}Landing → Dorian Migration${PURPLE}         ║${NC}"
    echo -e "${PURPLE}║  ${NC}Upgrade to generic plugin system   ${PURPLE} ║${NC}"
    echo -e "${PURPLE}║                                        ║${NC}"
    echo -e "${PURPLE}╚════════════════════════════════════════╝${NC}"
    echo ""
}

# Verify landing path
verify_landing() {
    title "Verifying Landing Project"

    if [[ ! -d "$LANDING_PATH" ]]; then
        error "Landing path not found: $LANDING_PATH"
        exit 1
    fi

    if [[ ! -d "$LANDING_PATH/.claude" ]]; then
        error "Not a landing project (no .claude/ directory)"
        exit 1
    fi

    if [[ ! -f "$LANDING_PATH/.claude/agents/planning-rules.md" ]]; then
        error "Invalid landing structure (missing agents)"
        exit 1
    fi

    success "Landing project verified: $LANDING_PATH"

    # Show current structure
    echo ""
    info "Current structure:"
    echo "  Plans:"
    find "$LANDING_PATH/.claude/plans" -name "*.md" 2>/dev/null | wc -l | xargs echo "    Total plans:"
    find "$LANDING_PATH/.claude/plans/active" -name "*.md" 2>/dev/null | wc -l | xargs echo "    Active:"
    find "$LANDING_PATH/.claude/plans/completed" -name "*.md" 2>/dev/null | wc -l | xargs echo "    Completed:"

    echo "  Worktrees:"
    for wt in 1 2 3 4; do
        if [[ -d "$LANDING_PATH/$wt" ]]; then
            echo "    ✓ Worktree $wt"
        fi
    done
    echo ""
}

# Confirm migration
confirm_migration() {
    warning "This will modify the landing project structure"
    echo ""
    echo "Changes:"
    echo "  1. Replace agents with generic dorian agents"
    echo "  2. Flatten plans/ structure (remove active/completed)"
    echo "  3. Add Status field to existing plans"
    echo "  4. Install plugins (security, review, design)"
    echo "  5. Create .dorian.json in each worktree"
    echo "  6. Update .gitignore"
    echo ""
    warning "A backup will be created in git"
    echo ""
    read -p "$(echo -e ${BLUE}ℹ${NC}  'Continue with migration? (y/N) ')" -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        info "Migration cancelled"
        exit 0
    fi
}

# Create backup
create_backup() {
    title "Creating Backup"

    cd "$LANDING_PATH"

    # Check if we're in a git repo
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        error "Not a git repository"
        exit 1
    fi

    local backup_name=".claude-backup-$(date +%Y%m%d-%H%M%S)"

    # Copy .claude excluding the self-referencing symlink
    mkdir -p "$backup_name"

    # Copy all contents except .claude symlink
    for item in .claude/*; do
        [[ "$item" == ".claude/.claude" ]] && continue
        cp -r "$item" "$backup_name/" 2>/dev/null || true
    done

    success "Created backup: $backup_name"

    # For bare repos, backup is stored in bare repo root
    # We'll commit it later from worktree along with migration changes
    success "Backup created (will be committed with migration)"
    echo ""
    info "Backup location: $LANDING_PATH/$backup_name"
    echo ""
}

# Migrate agents
migrate_agents() {
    title "Migrating Agents"

    # Debug: Show template path
    info "Template directory: $DORIAN_TEMPLATES"

    if [[ ! -d "$DORIAN_TEMPLATES/agents" ]]; then
        error "Template directory not found: $DORIAN_TEMPLATES/agents"
        exit 1
    fi

    cd "$LANDING_PATH/.claude"

    # Copy generic agents (use absolute paths)
    cp "$DORIAN_TEMPLATES/agents/planning-rules.md" agents/planning-rules.md
    cp "$DORIAN_TEMPLATES/agents/execution-rules.md" agents/execution-rules.md

    success "Replaced with generic dorian agents"

    # Copy commands
    cp "$DORIAN_TEMPLATES/commands/plan.md" commands/plan.md
    cp "$DORIAN_TEMPLATES/commands/exec.md" commands/exec.md

    success "Updated slash commands"
}

# Migrate plans
migrate_plans() {
    title "Migrating Plans"

    cd "$LANDING_PATH/.claude/plans"

    # Move active plans to root
    if [[ -d "active" ]] && [[ -n "$(ls -A active 2>/dev/null)" ]]; then
        info "Moving active plans to root..."
        mv active/*.md . 2>/dev/null || true
        mv active/*.sh . 2>/dev/null || true
        success "Moved $(ls active/ 2>/dev/null | wc -l | tr -d ' ') files from active/"
    fi

    # Move completed plans to root
    if [[ -d "completed" ]] && [[ -n "$(ls -A completed 2>/dev/null)" ]]; then
        info "Moving completed plans to root..."
        mv completed/*.md . 2>/dev/null || true
        mv completed/*.sh . 2>/dev/null || true
        success "Moved $(ls completed/ 2>/dev/null | wc -l | tr -d ' ') files from completed/"
    fi

    # Remove empty directories
    rmdir active 2>/dev/null || true
    rmdir completed 2>/dev/null || true

    success "Flattened plan structure"

    # Add Status field to plans that don't have it
    info "Updating plan format..."
    for plan in PLAN-*.md; do
        [[ -f "$plan" ]] || continue
        if ! grep -q "^**Status**:" "$plan"; then
            # Add Status after first line (title)
            sed -i.bak '1 a\
\
**Status**: completed' "$plan"
            rm "${plan}.bak"
            info "  Updated: $plan"
        fi
    done

    success "Plans migrated to dorian format"
}

# Install plugins
install_plugins() {
    title "Installing Plugins"

    cd "$LANDING_PATH/.claude"
    mkdir -p plugins

    # Copy recommended plugins
    cp -r "$DORIAN_TEMPLATES/plugins/security-guidance" plugins/
    success "Installed: security-guidance"

    cp -r "$DORIAN_TEMPLATES/plugins/pr-review-toolkit" plugins/
    success "Installed: pr-review-toolkit"

    cp -r "$DORIAN_TEMPLATES/plugins/frontend-design" plugins/
    success "Installed: frontend-design (Next.js)"

    echo ""
    info "Plugins installed in .claude/plugins/"
}

# Create .dorian.json for each worktree
create_dorian_configs() {
    title "Creating Worktree Configurations"

    for wt in 1 2 3 4; do
        local worktree_path="$LANDING_PATH/$wt"
        [[ -d "$worktree_path" ]] || continue

        info "Configuring worktree $wt..."

        cd "$worktree_path"

        # Run dorian init
        if command -v dorian >/dev/null 2>&1; then
            # Use dorian init if available (will auto-detect)
            # But we need to answer prompts programmatically
            # For now, create manually based on existing CLAUDE.md
            create_dorian_json_manual "$worktree_path"
        else
            create_dorian_json_manual "$worktree_path"
        fi

        success "  Worktree $wt configured"
    done

    echo ""
}

create_dorian_json_manual() {
    local wt_path=$1
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    cat > "$wt_path/.dorian.json" <<'EOF'
{
  "version": "1.0",
  "project": {
    "name": "landing",
    "type": "nextjs",
    "initialized": "TIMESTAMP_PLACEHOLDER",
    "description": "Landing page boilerplate with plan-driven development"
  },
  "quality_gates": {
    "test": {
      "command": "bun test",
      "on_fail": "stop",
      "enabled": true
    },
    "typecheck": {
      "command": "cd apps/web && tsc --noEmit --skipLibCheck",
      "exclude_patterns": ["__tests__", "**/*.test.*", "**/*.spec.*"],
      "on_fail": "stop",
      "enabled": true
    },
    "lint": {
      "command": "bun run check",
      "on_fail": "warn",
      "enabled": true
    },
    "build": {
      "command": "bun run build",
      "on_fail": "stop",
      "enabled": true
    }
  },
  "git": {
    "base_branch": "main",
    "branch_prefix": "feat/",
    "commit_convention": "conventional",
    "merge_strategy": "squash"
  },
  "mcp": {
    "project_servers": ["chrome-devtools", "nextjs"],
    "enabled": true,
    "config_path": "./.mcp.json"
  },
  "execution": {
    "current_plan": null,
    "last_executed": null,
    "last_execution_time": null,
    "mode": "classic"
  },
  "agent_behavior": {
    "auto_commit_steps": true,
    "stop_on_quality_gate_fail": true,
    "create_pr_on_completion": true,
    "archive_completed_plans": false
  }
}
EOF

    # Replace timestamp
    sed -i.bak "s/TIMESTAMP_PLACEHOLDER/$timestamp/" "$wt_path/.dorian.json"
    rm -f "$wt_path/.dorian.json.bak"
}

# Update gitignore
update_gitignore() {
    title "Updating .gitignore"

    cd "$LANDING_PATH"

    # Find gitignore in worktree 1 (bare repos don't have root gitignore)
    local gitignore_path="$LANDING_PATH/1/.gitignore"

    if [[ ! -f "$gitignore_path" ]]; then
        warning ".gitignore not found, skipping"
        return
    fi

    # Add dorian entries if not already there
    if ! grep -q ".dorian.json" "$gitignore_path" 2>/dev/null; then
        cat >> "$gitignore_path" <<'EOF'

# Dorian local configuration
.dorian.json
.dorian.json.backup
.dorian.json.tmp

# Claude Code local settings (if not already ignored)
.claude/settings.local.json
EOF
        success "Updated .gitignore"
    else
        info ".gitignore already has dorian entries"
    fi
}

# Commit changes
commit_migration() {
    title "Committing Migration"

    cd "$LANDING_PATH"

    # Check if bare repo
    if git rev-parse --is-bare-repository 2>/dev/null | grep -q "true"; then
        # Bare repo - commit from first worktree
        local first_worktree="$LANDING_PATH/1"
        cd "$first_worktree"

        # For bare repos, we need to use the worktree's .claude symlink
        # The symlink points to ../.claude which git can track

        # Stage all changes to .claude via the symlink
        git add .claude/
        git add .gitignore 2>/dev/null || true

        # Commit (include backup info in message)
        local backup_name=$(ls "$LANDING_PATH" | grep "^\.claude-backup-" | tail -1)
        git commit -m "feat: migrate to dorian plugin system

Backup created: $backup_name (in bare repo root)
Location: $LANDING_PATH/$backup_name

Changes:
- Replace landing-specific agents with generic dorian agents
- Flatten plans/ structure (remove active/completed)
- Add Status field to all plans
- Install plugins: security-guidance, pr-review-toolkit, frontend-design
- Create .dorian.json for each worktree (not committed)
- Update .gitignore with dorian entries

Migration completed: $(date)

See: ~/personal/dotfiles/.claude/templates/PLUGIN-INTEGRATION.md"

        success "Migration committed (from worktree 1)"
    else
        # Regular repo
        git add .claude/
        git add .gitignore 2>/dev/null || true

        git commit -m "feat: migrate to dorian plugin system

Changes:
- Replace landing-specific agents with generic dorian agents
- Flatten plans/ structure (remove active/completed)
- Add Status field to all plans
- Install plugins: security-guidance, pr-review-toolkit, frontend-design
- Create .dorian.json for each worktree (not committed)
- Update .gitignore with dorian entries

Migration completed: $(date)

See: ~/personal/dotfiles/.claude/templates/PLUGIN-INTEGRATION.md"

        success "Migration committed"
    fi
}

# Show next steps
show_next_steps() {
    title "Migration Complete!"

    echo ""
    success "Landing project successfully migrated to dorian"
    echo ""
    echo "What was changed:"
    echo "  ✓ Agents: Generic dorian agents (read CLAUDE.md/.dorian.json)"
    echo "  ✓ Plans: Flattened structure, added Status field"
    echo "  ✓ Plugins: security-guidance, pr-review-toolkit, frontend-design"
    echo "  ✓ Config: .dorian.json in each worktree (gitignored)"
    echo "  ✓ Backup: Preserved in git"
    echo ""
    echo "Files created per worktree:"
    echo "  ❌ .dorian.json (NOT committed - local state)"
    echo ""
    echo "Files committed:"
    echo "  ✅ .claude/agents/ (generic agents)"
    echo "  ✅ .claude/commands/ (updated commands)"
    echo "  ✅ .claude/plans/ (flattened, with Status)"
    echo "  ✅ .claude/plugins/ (3 plugins)"
    echo "  ✅ .gitignore (dorian entries)"
    echo ""
    echo "Next steps:"
    echo ""
    echo "  1. Test in worktree 1:"
    echo "     cd $LANDING_PATH/1"
    echo "     dorian status"
    echo "     dorian list"
    echo ""
    echo "  2. Create a test plan:"
    echo "     dorian plan \"Test migration\""
    echo ""
    echo "  3. Execute test plan:"
    echo "     dorian exec PLAN-*.md"
    echo ""
    echo "  4. If everything works, use in all worktrees!"
    echo ""
    info "Rollback available if needed:"
    echo "  rollback-landing-migration <backup-dir-name>"
    echo ""
}

# Main flow
main() {
    show_banner
    verify_landing
    confirm_migration
    create_backup
    migrate_agents
    migrate_plans
    install_plugins
    create_dorian_configs
    update_gitignore
    commit_migration
    show_next_steps
}

main "$@"
