#!/bin/bash
# Switch to a specific workspace (1-4) within current repo
# Usage: switch-workspace <1|2|3|4>

WORKSPACE_NUM="$1"

if [ -z "$WORKSPACE_NUM" ] || ! [[ "$WORKSPACE_NUM" =~ ^[1-4]$ ]]; then
  echo "Usage: switch-workspace <1|2|3|4>"
  exit 1
fi

# Check if we're in tmux
if [ -z "$TMUX" ]; then
  echo "Error: Must be run inside tmux"
  exit 1
fi

# Get current pane's directory
CURRENT_PATH=$(tmux display-message -p '#{pane_current_path}')

# # Check if we're in a non-bare repo (has .git directory)
# if [ -d "$CURRENT_PATH/.git" ] || git -C "$CURRENT_PATH" rev-parse --is-inside-work-tree &>/dev/null 2>&1; then
#   # In a non-bare repo, silently exit
#   exit 0
# fi

# Find the bare repo by looking for .git directory going up
find_bare_repo() {
  local dir="$1"
  while [ "$dir" != "/" ]; do
    # Check if this directory is a workspace (has parent that's .git)
    local parent=$(dirname "$dir")
    if [ -f "$parent/config" ] && [ -d "$parent/refs" ]; then
      # Parent is a bare repo
      echo "$parent"
      return 0
    fi
    # Check if we're already in a .git directory
    if [ -f "$dir/config" ] && [ -d "$dir/refs" ]; then
      echo "$dir"
      return 0
    fi
    dir="$parent"
  done
  return 1
}

# Create a worktree for a bare repository
# Args: $1 = bare_repo_path, $2 = worktree_number (1-4)
# Returns: 0 on success, 1 on failure
create_worktree_if_needed() {
  local bare_repo="$1"
  local worktree_num="$2"
  local worktree_path="$bare_repo/$worktree_num"

  # Check if worktree already exists
  if [ -d "$worktree_path" ]; then
    return 0
  fi

  # Prune stale worktree metadata first
  git -C "$bare_repo" worktree prune 2>/dev/null

  # Determine default branch
  local default_branch=""
  if git -C "$bare_repo" show-ref --verify --quiet refs/heads/main; then
    default_branch="main"
  elif git -C "$bare_repo" show-ref --verify --quiet refs/heads/master; then
    default_branch="master"
  else
    # Use whatever HEAD points to
    default_branch=$(git -C "$bare_repo" symbolic-ref --short HEAD 2>/dev/null || echo "main")
  fi

  # Check if repo has any commits
  if ! git -C "$bare_repo" rev-parse --verify HEAD &>/dev/null; then
    echo "Error: Repository has no commits"
    return 1
  fi

  # Create the worktree
  echo "Creating worktree $worktree_num at: $worktree_path (branch: $default_branch)"
  if ! git -C "$bare_repo" worktree add "$worktree_path" "$default_branch" 2>/dev/null; then
    echo "Error: Failed to create worktree $worktree_num"
    return 1
  fi

  # Create .claude symlink if bare repo has .claude config
  if [ -d "$bare_repo/.claude" ]; then
    ln -sf ../.claude "$worktree_path/.claude"
    echo "Created .claude symlink for shared configuration"
  fi

  echo "✓ Worktree $worktree_num created successfully"
  return 0
}

# Create tmux session for a worktree
# Args: $1 = session_name, $2 = worktree_path
# Returns: 0 on success, 1 on failure
create_tmux_session_for_worktree() {
  local session_name="$1"
  local worktree_path="$2"

  # Check if session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    return 0
  fi

  echo "Creating tmux session: $session_name"

  # Create new session with first window (terminal only)
  tmux new-session -ds "$session_name" -c "$worktree_path"

  # Window 1: Split for Claude in right pane (60/40)
  # Right pane is a terminal (not running claude directly)
  # This prevents Ctrl+C from closing the pane
  tmux split-window -t "$session_name:1" -h -p 40 -c "$worktree_path"

  # Create window 2 with nvim
  tmux new-window -t "$session_name:2" -c "$worktree_path"
  tmux send-keys -t "$session_name:2" 'nvim .' C-m

  # Focus on window 1 (terminal + claude pane)
  tmux select-window -t "$session_name:1"

  echo "✓ Session $session_name created"
  return 0
}

BARE_REPO=$(find_bare_repo "$CURRENT_PATH")

if [ -z "$BARE_REPO" ]; then
  # Not in a workspace repository, silently exit
  exit 0
fi

# Get repo name from bare repo path and sanitize (replace dots with underscores)
REPO_NAME=$(basename "$BARE_REPO" .git)
SAFE_REPO_NAME=$(echo "$REPO_NAME" | tr . _)
TARGET_SESSION="${SAFE_REPO_NAME}_${WORKSPACE_NUM}"
TARGET_WORKTREE="$BARE_REPO/$WORKSPACE_NUM"

# Create worktree if it doesn't exist
if [ ! -d "$TARGET_WORKTREE" ]; then
  echo "Worktree $WORKSPACE_NUM does not exist, creating it..."
  if ! create_worktree_if_needed "$BARE_REPO" "$WORKSPACE_NUM"; then
    tmux display-message "⚠ Failed to create worktree $WORKSPACE_NUM"
    exit 1
  fi
fi

# Create tmux session if it doesn't exist
if ! tmux has-session -t "$TARGET_SESSION" 2>/dev/null; then
  if ! create_tmux_session_for_worktree "$TARGET_SESSION" "$TARGET_WORKTREE"; then
    tmux display-message "⚠ Failed to create session $TARGET_SESSION"
    exit 1
  fi
fi

# Switch to the target workspace session
tmux switch-client -t "$TARGET_SESSION"

# Noise I don't like
# # Show notification
# tmux display-message "→ Workspace $WORKSPACE_NUM ($TARGET_SESSION)"
